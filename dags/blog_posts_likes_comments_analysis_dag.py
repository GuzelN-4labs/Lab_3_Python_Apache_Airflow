# -*- coding: utf-8 -*-
"""blog_posts_db.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1C_q9DwAdFPqQmTNfLtRF6TVsaJfc7vmA
"""

"""
DAG –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã.
–í–∞—Ä–∏–∞–Ω—Ç –∑–∞–¥–∞–Ω–∏—è ‚Ññ16

–ê–≤—Ç–æ—Ä: –ù—É—Ä–≥–∞–ª–µ–µ–≤–∞ –ì—É–∑–µ–ª—å
–î–∞—Ç–∞: 2025
"""

from datetime import datetime, timedelta
import pandas as pd
import json
import sqlite3
import os
from airflow import DAG
from airflow.operators.python_operator import PythonOperator
from airflow.operators.email_operator import EmailOperator
from airflow.utils.dates import days_ago

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è DAG
default_args = {
    'owner': 'student',
    'depends_on_past': False,
    'start_date': days_ago(1),
    'email_on_failure': True,
    'email_on_retry': False,
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
    'email': ['test@example.com']
}

# –°–æ–∑–¥–∞–Ω–∏–µ DAG
dag = DAG(
    'blog_posts_likes_comments_analysis',
    default_args=default_args,
    description='–†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã',
    schedule_interval=timedelta(days=1),
    catchup=False,
    tags=['etl', 'blog_posts', 'likes', 'comments', 'variant_16']
)

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –¥–∞–Ω–Ω—ã—Ö
DATA_DIR = '/opt/airflow/dags/data'
DB_PATH = '/opt/airflow/blog_posts_likes_comments_analysis.db'

def extract_blog_posts_data(**context):
    """
    Extract: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –∏–∑ CSV —Ñ–∞–π–ª–∞
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –∏–∑ CSV...")

    csv_path = os.path.join(DATA_DIR, 'blog_posts.csv')

    try:
        # –ß—Ç–µ–Ω–∏–µ CSV —Ñ–∞–π–ª–∞
        blog_posts_df = pd.read_csv(csv_path)
        print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(blog_posts_df)} –∑–∞–ø–∏—Å–µ–π –æ –ø–æ—Å—Ç–∞—Ö")
        print("–ü–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π:")
        print(blog_posts_df.head())

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–¥–∞—á
        blog_posts_data = blog_posts_df.to_dict('records')
        context['task_instance'].xcom_push(key='blog_posts_data', value=blog_posts_data)

        print("–î–∞–Ω–Ω—ã–µ –æ –ø–æ—Å—Ç–∞—Ö —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ XCom")
        return f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(blog_posts_df)} –∑–∞–ø–∏—Å–µ–π –æ –ø–æ—Å—Ç–∞—Ö"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç–∞—Ö: {str(e)}")
        raise

def extract_likes_data(**context):
    """
    Extract: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ª–∞–π–∫–∞—Ö –∏–∑ Excel —Ñ–∞–π–ª–∞
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ª–∞–π–∫–∞—Ö –∏–∑ Excel...")

    excel_path = os.path.join(DATA_DIR, 'likes.xlsx')

    try:
        # –ß—Ç–µ–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
        likes_df = pd.read_excel(excel_path)
        print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(likes_df)} –∑–∞–ø–∏—Å–µ–π –æ –ª–∞–π–∫–∞—Ö")
        print("–ü–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π:")
        print(likes_df.head())

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–¥–∞—á
        likes_data = likes_df.to_dict('records')
        context['task_instance'].xcom_push(key='likes_data', value=likes_data)

        print("–î–∞–Ω–Ω—ã–µ –æ –ª–∞–π–∫–∞—Ö —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ XCom")
        return f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(likes_df)} –∑–∞–ø–∏—Å–µ–π –æ –ª–∞–π–∫–∞—Ö"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö: {str(e)}")
        raise

def extract_comments_w_likes_data(**context):
    """
    Extract: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ JSON —Ñ–∞–π–ª–∞
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ JSON...")

    json_path = os.path.join(DATA_DIR, 'comments_w_likes.json')

    try:
        # –ß—Ç–µ–Ω–∏–µ JSON —Ñ–∞–π–ª–∞
        with open(json_path, 'r', encoding='utf-8') as f:
            comments_w_likes_data = json.load(f)

        comments_w_likes_df = pd.DataFrame(comments_w_likes_data)
        print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(comments_w_likes_df)} –∑–∞–ø–∏—Å–µ–π –æ –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
        print("–ü–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π:")
        print(comments_w_likes_df.head())

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–¥–∞—á
        context['task_instance'].xcom_push(key='comments_w_likes_data', value=comments_w_likes_data)

        print("–î–∞–Ω–Ω—ã–µ –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ XCom")
        return f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(comments_w_likes_df)} –∑–∞–ø–∏—Å–µ–π –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ  –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {str(e)}")
        raise

def extract_comments_wo_likes_data(**context):
    """
    Extract: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –Ω–µ –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ JSON —Ñ–∞–π–ª–∞
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –Ω–µ –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ JSON...")

    json_path = os.path.join(DATA_DIR, 'comments_wo_likes.json')

    try:
        # –ß—Ç–µ–Ω–∏–µ JSON —Ñ–∞–π–ª–∞
        with open(json_path, 'r', encoding='utf-8') as f:
            comments_wo_likes_data = json.load(f)

        comments_wo_likes_df = pd.DataFrame(comments_wo_likes_data)
        print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(comments_wo_likes_df)} –∑–∞–ø–∏—Å–µ–π –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –Ω–µ –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
        print("–ü–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π:")
        print(comments_wo_likes_df.head())

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–¥–∞—á
        context['task_instance'].xcom_push(key='comments_wo_likes_data', value=comments_wo_likes_data)

        print("–î–∞–Ω–Ω—ã–µ –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –Ω–µ –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ XCom")
        return f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(comments_wo_likes_df)} –∑–∞–ø–∏—Å–µ–π –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –Ω–µ –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ—Ç –Ω–µ –ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {str(e)}")
        raise

def transform_data(**context):
    """
    Transform: –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ —Ç–µ–º—É –ø–æ—Å—Ç–∞
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö...")

    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–¥–∞—á
        blog_posts_data = context['task_instance'].xcom_pull(key='blog_posts_data', task_ids='extract_blog_posts')
        likes_data = context['task_instance'].xcom_pull(key='likes_data', task_ids='extract_likes')
        comments_w_likes_data = context['task_instance'].xcom_pull(key='comments_w_likes_data', task_ids='extract_comments_w_likes')
        comments_wo_likes_data = context['task_instance'].xcom_pull(key='comments_wo_likes_data', task_ids='extract_comments_wo_likes')

        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ DataFrame
        blog_posts_df = pd.DataFrame(blog_posts_data)
        likes_df = pd.DataFrame(likes_data)
        comments_w_likes_df = pd.DataFrame(comments_w_likes_data)
        comments_wo_likes_df = pd.DataFrame(comments_wo_likes_data)

        print("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ XCom")
        print(f"–ü–æ—Å—Ç—ã: {len(blog_posts_df)} –∑–∞–ø–∏—Å–µ–π")
        print(f"–õ–∞–π–∫–∏: {len(likes_df)} –∑–∞–ø–∏—Å–µ–π")
        print(f"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: {len(comments_w_likes_df)} –∑–∞–ø–∏—Å–µ–π")
        print(f"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±–µ–∑ –ª–∞–π–∫–æ–≤: {len(comments_wo_likes_df)} –∑–∞–ø–∏—Å–µ–π")

        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        # —Å–Ω–∞—á–∞–ª–∞ –æ–±—ä–µ–¥–∏–Ω—é –¥–≤–∞ –≤–∏–¥–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
        comments_df = pd.concat([comments_w_likes_df, comments_wo_likes_df], axis=0).reset_index() #.drop({'index'}, axis = 1)

        # –æ–±—ä–µ–¥–∏–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –≤ –æ–¥–∏–Ω. –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ

        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ª–∞–π–∫–∞–º–∏
        merged_df = pd.merge(blog_posts_df, likes_df, on = 'post_id', how = "left")

        # –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
        merged_df_2 = pd.merge(merged_df, comments_df, on='post_id', how = "left", suffixes = ['_likes', '_all_comments'])

        # –ù—É –∏ —Ä–∞–∑ —Å–¥–µ–ª–∞–Ω –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—Ç –Ω–µ–ª–∞–π–∫–Ω—É–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ç–æ –º–æ–∂–Ω–æ –∏—Ö –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Ö –¥–æ–ª—é
        final_df = pd.merge(merged_df_2, comments_wo_likes_df.rename({'user_id':"user_id_comments_wo_likes"}, axis = 1), on = 'post_id', how = "left")
        print(f"–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è: {len(final_df)} –∑–∞–ø–∏—Å–µ–π")

        # –†–∞—Å—á–µ—Ç –ø–æ –ø–æ—Å—Ç–∞–º
        print("–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö user_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞ (–∫–∞–∫ –ø–æ –ª–∞–π–∫–∞–º, —Ç–∞–∫ –∏ –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º)...")

        blog_posts_analysis = final_df.groupby(['topic', 'post_id']).agg({
            'user_id_likes': 'nunique',
            'user_id_all_comments': 'nunique',
            'user_id_comments_wo_likes': 'nunique'
        }).reset_index()


        # –†–∞—Å—á–µ—Ç –ø–æ —Ç–æ–ø–∏–∫–∞–º
        blog_posts_analysis_by_topics = blog_posts_analysis.groupby(['topic']).agg({
            'post_id': 'nunique',
            'user_id_likes': 'mean',
            'user_id_all_comments': 'mean',
            'user_id_comments_wo_likes': 'mean'
        }).reset_index()

        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
        blog_posts_analysis_by_topics.columns = ['topic', 'total_posts', 'avg_likes', 'avg_comments', 'avg_comments_wo_likes']
        blog_posts_analysis_by_topics['comments_wo_likes_share'] = blog_posts_analysis_by_topics['avg_comments_wo_likes']/blog_posts_analysis_by_topics['avg_comments']

        print("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã:")
        print(blog_posts_analysis_by_topics)

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ë–î
        result_data = blog_posts_analysis_by_topics.to_dict('records')
        context['task_instance'].xcom_push(key='blog_posts_analysis_by_topics', value = result_data)

        print("–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
        return f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {len(blog_posts_analysis_by_topics)} —Ç–æ–ø–∏–∫–æ–≤"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
        raise

def load_to_database(**context):
    """
    Load: –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –≤ SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")

    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
        blog_posts_analysis_by_topics_data = context['task_instance'].xcom_pull(
                                  key='blog_posts_analysis_by_topics',
                                  task_ids='transform_data'
                                  )

        if not blog_posts_analysis_by_topics_data:
            raise ValueError("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö")

        # –°–æ–∑–¥–∞–Ω–∏–µ DataFrame –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        blog_posts_analysis_by_topics_df = pd.DataFrame(blog_posts_analysis_by_topics_data)

        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SQLite –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        conn = sqlite3.connect(DB_PATH)
        try:
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            create_table_query = """
            CREATE TABLE IF NOT EXISTS blog_posts_analysis_by_topics (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                topic TEXT NOT NULL,
                total_posts INTEGER NOT NULL,
                avg_likes  NUMERIC(10,2) NOT NULL,
                avg_comments NUMERIC(10,2)NOT NULL,
                avg_comments_wo_likes NUMERIC(10,2) NOT NULL,
                comments_wo_likes_share NUMERIC(10,2) NOT NULL
            )
            """
            conn.execute(create_table_query)

            # –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            conn.execute("DELETE FROM blog_posts_analysis_by_topics")

            # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É
            blog_posts_analysis_by_topics_df.to_sql('blog_posts_analysis_by_topics', conn, if_exists='append', index=False)

            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            conn.commit()

            print(f"–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ {len(blog_posts_analysis_by_topics_df)} –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            verification_query = "SELECT * FROM blog_posts_analysis_by_topics ORDER BY avg_likes DESC"
            result = pd.read_sql_query(verification_query, conn)
            print("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:")
            print(result)

        finally:
            conn.close()

        print("–ó–∞–≥—Ä—É–∑–∫–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
        return f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(blog_posts_analysis_by_topics_df)} –∑–∞–ø–∏—Å–µ–π –≤ SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
        raise

def generate_report(**context):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
    """
    print("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞...")

    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        conn = sqlite3.connect(DB_PATH)

        try:
            query = """
            SELECT
                topic,
                total_posts,
                avg_likes,
                avg_comments,
                avg_comments_wo_likes,
                comments_wo_likes_share
            FROM blog_posts_analysis_by_topics
            ORDER BY avg_likes DESC
            """

            result_df = pd.read_sql_query(query, conn)

            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
            report = f"""–û–¢–ß–ï–¢ –ü–û –†–ê–°–ß–ï–¢–£ –°–†–ï–î–ù–ï–ì–û –ö–û–õ–ò–ß–ï–°–¢–í–ê –õ–ê–ô–ö–û–í –ò –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í –ù–ê –¢–û–ü–ò–ö
================================================================

–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}


–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û –¢–û–ü–ò–ö–ê–ú:
"""

            for _, row in result_df.iterrows():
                report += f"""
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {row['topic']}
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤: {row['total_posts']:,}
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤ –Ω–∞ –ø–æ—Å—Ç: {row['avg_likes']:,}
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç: {row['avg_comments']:,}
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç, —Å—Ä–µ–¥–∏ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–≤—à–∏—Ö –ª–∞–π–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {row['avg_comments_wo_likes']:,}
- –î–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Å—Ç–∞–≤–∏–≤—à–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –Ω–æ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–≤–∏—à–∏—Ö –ª–∞–π–∫, –≤ –æ–±—â–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {row['comments_wo_likes_share']*100:.2f}%
"""

            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            total_topics = result_df['topic'].count()
            avg_posts = result_df['total_posts'].mean()

            # —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ DataFrame –¥–ª—è –¥–æ–ø—Ä–∞—Å—á–µ—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ –∏–∑–º–µ–Ω—è—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            assist_result_df = result_df.copy()
            assist_result_df['total_avg_likes']=assist_result_df['avg_likes']*assist_result_df['total_posts']
            assist_result_df['total_avg_comments']=assist_result_df['avg_comments']*assist_result_df['total_posts']

            avg_likes = assist_result_df['total_avg_likes'].sum()/assist_result_df['total_posts'].sum()
            avg_comments = assist_result_df['total_avg_comments'].sum()/assist_result_df['total_posts'].sum()

            report += f"""
–û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø–∏–∫–æ–≤ (—Ç–µ–º): {total_topics:,}
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –≤ —Ç–µ–º–µ: {avg_posts:,}
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤ –ø–æ –≤—Å–µ–º —Ç–µ–º–∞–º: {avg_likes:,}
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ –≤—Å–µ–º —Ç–µ–º–∞–º: {avg_comments:,}


–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
"""

            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
            best_topic = result_df.iloc[0]
            worst_topic = result_df.iloc[-1]

            report += f"""- –õ—É—á—à–∞—è —Ç–µ–º–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ª–∞–π–∫–æ–≤ "{best_topic['topic']}" ({best_topic['avg_likes']})
- –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è —Ç–µ–º–∞ "{worst_topic['topic']}" ({worst_topic['avg_likes']})
"""

            print("–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:")
            print(report)

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–∞–π–ª
            report_file_path = '/opt/airflow/blog_posts_analysis_report.txt'
            with open(report_file_path, 'w', encoding='utf-8') as f:
                f.write(report)
            print(f"–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {report_file_path}")

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ CSV —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
            csv_file_path = '/opt/airflow/blog_posts_analysis_data.csv'
            result_df.to_csv(csv_file_path, index=False, encoding='utf-8')
            print(f"–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ CSV: {csv_file_path}")

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è email
            context['task_instance'].xcom_push(key='report', value=report)
            context['task_instance'].xcom_push(key='report_file_path', value=report_file_path)
            context['task_instance'].xcom_push(key='csv_file_path', value=csv_file_path)
            context['task_instance'].xcom_push(key='result_data', value=result_df.to_dict('records'))

        finally:
            conn.close()

        return "–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª—ã"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: {str(e)}")
        raise

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á DAG

# Extract –∑–∞–¥–∞—á–∏
extract_blog_posts_task = PythonOperator(
    task_id='extract_blog_posts',
    python_callable = extract_blog_posts_data,
    dag=dag,
    doc_md="""
    ### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç–∞–≤—Ö, –∞–≤—Ç–æ—Ä–∞—Ö, —Ç–µ–º–∞—Ö
    –ß–∏—Ç–∞–µ—Ç CSV —Ñ–∞–π–ª.
    """
)

extract_likes_task = PythonOperator(
    task_id='extract_likes',
    python_callable = extract_likes_data,
    dag=dag,
    doc_md="""
    ### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ª–∞–π–∫–∞—Ö (post_id, user_id)
    –ß–∏—Ç–∞–µ—Ç Excel —Ñ–∞–π–ª.
    """
)

extract_comments_w_likes_task = PythonOperator(
    task_id='extract_comments_w_likes',
    python_callable = extract_comments_w_likes_data,
    dag=dag,
    doc_md="""
    ### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö —Ç–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç–∞–∫–∂–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –ª–∞–π–∫
    –ß–∏—Ç–∞–µ—Ç JSON —Ñ–∞–π–ª.
    """
)

extract_comments_wo_likes_task = PythonOperator(
    task_id='extract_comments_wo_likes',
    python_callable = extract_comments_wo_likes_data,
    dag=dag,
    doc_md="""
    ### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö —Ç–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –ª–∞–π–∫
    –ß–∏—Ç–∞–µ—Ç JSON —Ñ–∞–π–ª.
    """
)

# Transform –∑–∞–¥–∞—á–∞
transform_task = PythonOperator(
    task_id='transform_data',
    python_callable=transform_data,
    dag=dag,
    doc_md="""
    ### –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ —Ç–µ–º—É.
    """
)

# Load –∑–∞–¥–∞—á–∞
load_task = PythonOperator(
    task_id='load_to_database',
    python_callable=load_to_database,
    dag=dag,
    doc_md="""
    ### –ó–∞–≥—Ä—É–∑–∫–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    """
)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
report_task = PythonOperator(
    task_id='generate_report',
    python_callable=generate_report,
    dag=dag,
    doc_md="""
    ### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
    –°–æ–∑–¥–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞.
    """
)

def send_email_with_attachments(**context):
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ email —Å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    """
    from airflow.utils.email import send_email
    import os

    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–¥–∞—á
        report = context['task_instance'].xcom_pull(key='report', task_ids='generate_report')
        result_data = context['task_instance'].xcom_pull(key='result_data', task_ids='generate_report')

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        html_content = f"""
        <h2>üéâ –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã!</h2>

        <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏:</h3>
        <ul>
            <li><strong>DAG:</strong> blog_posts_likes_comments_analysis</li>
            <li><strong>–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> {context['ds']}</li>
            <li><strong>–°—Ç–∞—Ç—É—Å:</strong> ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫</li>
            <li><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong> –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite</li>
        </ul>

        <h3>üìà –ö—Ä–∞—Ç–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:</h3>
        <table border="1" style="border-collapse: collapse; width: 100%;">
            <tr style="background-color: #f2f2f2;">
                <th>–¢–µ–º–∞</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤</th>
                <th>–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤</th>
                <th>–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</th>
            </tr>
        """

        if result_data:
            for row in result_data:
                html_content += f"""
            <tr>
                <td>{row['topic']}</td>
                <td>{row['total_posts']:,}</td>
                <td>{row['avg_likes']:,}</td>
                <td>{row['avg_comments']:}</td>
            </tr>
                """

        html_content += """
        </table>

        <h3>üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</h3>
        <ul>
            <li><strong>blog_posts_analysis_report.txt</strong> - –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç</li>
            <li><strong>blog_posts_analysis_data.csv</strong> - –î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV</li>
        </ul>

        <p><em>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ª–æ–≥–∞—Ö –∑–∞–¥–∞—á–∏ generate_report –≤ Airflow UI.</em></p>

        <hr>
        <p style="color: #666; font-size: 12px;">
            –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç —Å–∏—Å—Ç–µ–º—ã Apache Airflow<br>
            –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        </p>
        """

        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        files = []
        report_file = '/opt/airflow/blog_posts_analysis_report.txt'
        csv_file = '/opt/airflow/blog_posts_analysis_data.csv'

        if os.path.exists(report_file):
            files.append(report_file)
            print(f"–î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {report_file}")

        if os.path.exists(csv_file):
            files.append(csv_file)
            print(f"–î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {csv_file}")

        # –û—Ç–ø—Ä–∞–≤–∫–∞ email
        send_email(
            to=['test@example.com'],
            subject='üìä –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã',
            html_content=html_content,
            files=files
        )

        print("Email —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        return "Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏"

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email: {str(e)}")
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–µ–∑ —Ñ–∞–π–ª–æ–≤
        send_email(
            to=['test@example.com'],
            subject='‚ö†Ô∏è –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã - –ó–∞–≤–µ—Ä—à–µ–Ω (–±–µ–∑ —Ñ–∞–π–ª–æ–≤)',
            html_content=f"""
            <h3>–†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ –ø–æ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!</h3>
            <p>DAG: blog_posts_likes_comments_analysis</p>
            <p>–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {context['ds']}</p>
            <p>–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫.</p>
            <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏: {str(e)}</p>
            <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ª–æ–≥–∞—Ö –∑–∞–¥–∞—á–∏ generate_report.</p>
            """
        )
        raise

# Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å —Ñ–∞–π–ª–∞–º–∏
email_task = PythonOperator(
    task_id='send_email_notification',
    python_callable=send_email_with_attachments,
    dag=dag,
    doc_md="""
    ### –û—Ç–ø—Ä–∞–≤–∫–∞ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏.
    """
)

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
# Extract –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
[extract_blog_posts_task, extract_likes_task, extract_comments_w_likes_task, extract_comments_wo_likes_task] >> transform_task

# Transform -> Load -> Report -> Email (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)
transform_task >> load_task >> report_task >> email_task
