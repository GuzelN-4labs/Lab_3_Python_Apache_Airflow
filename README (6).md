Текст скорректирован, повторы убраны.

# Лабораторная работа №3. Оркестрация ETL-процессов с Apache Airflow

## Бизнес-задача. Анализ удержания пользователей мобильных приложений

### Описание проблемы

Компания-разработчик мобильных приложений нуждается в автоматизированном анализе эффективности своих продуктов. Ключевой метрикой является **коэффициент удержания пользователей** (Retention Rate) — показатель, который демонстрирует, какой процент пользователей продолжает использовать приложение после его установки.

### Бизнес-ценность решения

*   📊 **Автоматизация аналитики**. Ежедневный расчет ключевых метрик без участия аналитика.
*   🎯 **Выявление проблемных категорий**. Быстрое определение приложений с низким удержанием.
*   📈 **Принятие решений на основе данных**. Объективная оценка успешности продуктов.
*   ⏰ **Экономия времени**. Автоматическая обработка данных из разных источников.
*   📧 **Своевременное уведомление**. Автоматическая отправка отчетов заинтересованным лицам.

### Данные и логика расчета

**Исходные данные**

*   **Файл 1 (CSV)**. `apps.csv` — справочник приложений (`app_id`, `category`).
*   **Файл 2 (Excel)**. `installs.xlsx` — статистика установок (`app_id`, `installs_count`).
*   **Файл 3 (JSON)**. `uninstalls.json` — статистика удалений (`app_id`, `uninstalls_count`).

**Бизнес-логика расчета**

```
Retention Rate = (Installs - Uninstalls) / Installs × 100%
Churn Rate = Uninstalls / Installs × 100%
Retained Users = Installs - Uninstalls
```

**Ожидаемый результат.** Аналитический отчет по категориям приложений с бизнес-рекомендациями, автоматически отправляемый на email.


## Архитектура решения

### Общая схема системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           DOCKER COMPOSE ENVIRONMENT                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │   PostgreSQL    │    │   Apache        │    │    MailHog      │         │
│  │   Database      │    │   Airflow       │    │  Email Service  │         │
│  │                 │    │                 │    │                 │         │
│  │ Port: 5432      │    │ ┌─────────────┐ │    │ SMTP: 1025      │         │
│  │ User: airflow   │◄───┤ │ Webserver   │ │    │ Web: 8025       │         │
│  │ DB: airflow     │    │ │ Port: 8080  │ │    │                 │         │
│  │                 │    │ └─────────────┘ │    │                 │         │
│  └─────────────────┘    │ ┌─────────────┐ │    └─────────────────┘         │
│                         │ │ Scheduler   │ │                                │
│                         │ │             │ │                                │
│                         │ └─────────────┘ │                                │
│                         └─────────────────┘                                │
│                                   │                                        │
│                         ┌─────────▼─────────┐                              │
│                         │   DAGs Volume     │                              │
│                         │   ./dags:/opt/    │                              │
│                         │   airflow/dags    │                              │
│                         └───────────────────┘                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              HOST SYSTEM                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐          │
│  │   Data Files    │    │   DAG Files     │    │  Result Files   │          │
│  │                 │    │                 │    │                 │          │
│  │ apps.csv        │    │ mobile_apps_    │    │ *.db (SQLite)   │          │
│  │ installs.xlsx   │    │ retention_dag.py│    │ *.txt (Reports) │          │
│  │ uninstalls.json │    │                 │    │ *.csv (Data)    │          │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘          │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        Web Interfaces                               │    │
│  │                                                                     │    │
│  │  http://localhost:8080  - Apache Airflow UI                         │    │
│  │  http://localhost:8025  - MailHog Web Interface                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────────────────┘
```

### ETL-процесс

```
                    EXTRACT PHASE (Параллельно)
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  extract_apps   │  │extract_installs │  │extract_uninstalls│
│ (apps.csv)      │  │ (installs.xlsx) │  │(uninstalls.json)│
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
                    TRANSFORM PHASE
                ┌─────────────────┐
                │ transform_data  │
                │ (JOIN, GROUP BY,│
                │ CALCULATE)      │
                └─────────────────┘
                         │
                    LOAD PHASE
                ┌─────────────────┐
                │load_to_database │
                │ (SQLite)        │
                └─────────────────┘
                         │
                 REPORTING PHASE
                ┌─────────────────┐
                │generate_report  │
                │ (TXT, CSV)      │
                └─────────────────┘
                         │
               NOTIFICATION PHASE
                ┌─────────────────┐
                │send_email_      │
                │notification     │
                │ (HTML + Attach) │
                └─────────────────┘
```

## Технический стек

| Компонент | Технология | Назначение |
|---|---|---|
| **Оркестрация** | Apache Airflow 2.5.0 | Управление ETL-процессами |
| **Контейнеризация** | Docker + Docker Compose | Изоляция и развертывание |
| **База данных (Airflow)** | PostgreSQL 12 | Метаданные Airflow |
| **База данных (Результаты)**| SQLite | Хранение результатов анализа |
| **Обработка данных** | Python 3.8 + Pandas | ETL-логика и трансформации |
| **Работа с Excel** | openpyxl | Чтение Excel файлов |
| **Email-тестирование** | MailHog | Тестирование email-уведомлений |
| **Веб-интерфейс** | Airflow WebUI | Мониторинг и управление |

## Пошаговая инструкция запуска

### Шаг 1. Подготовка окружения

1.  **Клонирование проекта**:
    ```bash
    git clone https://github.com/BosenkoTM/DCCAS.git
    cd DCCAS/lw_03
    ```
2.  **Запуск всех сервисов**:
    ```bash
    sudo docker compose up -d
    ```
3.  **Проверка статуса контейнеров**:
    ```bash
    sudo docker ps
    ```
    Должны быть запущены: `webserver`, `scheduler`, `postgres`, `mailhog`.

### Шаг 2. Работа с Apache Airflow

*   **Доступ к веб-интерфейсу**:
    *   **URL**: http://localhost:8080
    *   **Логин/Пароль**: admin/admin
*   **Действия в Airflow UI**:
    1.  **Найдите DAG** `mobile_apps_retention_analysis` и убедитесь, что он включен.
    2.  **Запустите DAG** вручную, нажав кнопку "Trigger DAG" (▶️), или дождитесь автоматического запуска.
    3.  **Отслеживайте выполнение** через **Graph View** (визуализация), **Tree View** (история запусков) или **Gantt View** (диаграмма выполнения).
    4.  **Просматривайте логи** выполнения, кликнув на задачу и выбрав "View Log".

### Шаг 3. Проверка email-уведомлений в MailHog

*   **Доступ к MailHog**:
    *   **URL**: http://localhost:8025
*   **Что проверять**:
    *   После успешного выполнения DAG в MailHog появится письмо с темой **"📊 Анализ коэффициента удержания мобильных приложений - Результаты"**.
    *   Письмо содержит **HTML-таблицу** с результатами и **прикрепленные файлы**: `retention_analysis_report.txt` и `retention_analysis_data.csv`.

### Шаг 4. Проверка результатов анализа

Для удобной проверки результатов используйте скрипт `check_results.py`.

1.  **Установка зависимостей**:
    ```bash
    pip install -r requirements.txt
    ```
2.  **Проверка результатов в базе данных** (скрипт скопирует БД из контейнера и выведет данные):
    ```bash
    python3 check_results.py
    ```
3.  **Копирование файлов отчетов** из контейнера на хост-систему:
    ```bash
    python3 check_results.py --files
    ```

### Шаг 5. Остановка сервисов

```bash
sudo docker compose down
```

### Полная очистка проекта

Для полной очистки Docker-окружения (контейнеры, образы, тома) используйте скрипт:

```bash
# Сделать скрипт исполняемым
chmod +x cleanup.sh
# Запустить полную очистку (скрипт запросит подтверждение)
sudo ./cleanup.sh
```

## Результаты выполнения

После успешного выполнения DAG вы получите:

1.  **📧 Email-уведомление** с HTML-таблицей и прикрепленными файлами отчетов.
   
  ![mailhog_analit](img/mailhog_analit_report.jpg)
  
3.  **📁 Файлы с результатами**:
    *   `retention_analysis_report.txt` — подробный текстовый отчет с рекомендациями.
    *   `retention_analysis_data.csv` — данные в формате CSV для дальнейшего анализа.
    *   `mobile_apps_retention.db` — база данных SQLite с результатами.
4.  **📈 Бизнес-рекомендации**, основанные на анализе данных.

### Пример отчета

**Текстовый отчет:**

```
ОТЧЕТ ПО АНАЛИЗУ КОЭФФИЦИЕНТА УДЕРЖАНИЯ МОБИЛЬНЫХ ПРИЛОЖЕНИЙ
================================================================
Дата анализа: 2024-10-02 15:30:45

РЕЗУЛЬТАТЫ ПО КАТЕГОРИЯМ:
Категория: Games
- Коэффициент удержания: 80.00%
Категория: Social
- Коэффициент удержания: 70.00%
...

РЕКОМЕНДАЦИИ:
- Лучший показатель удержания у категории "Games" (80.00%).
- Требует внимания категория "Social" (70.00%).
- Рекомендуется изучить успешные практики категории "Games".
```

**Таблица в Email и CSV:**

| Категория | Установки | Удаления | Коэффициент удержания |
|---|---|---|---|
| Games | 39,000 | 7,800 | 80.00% |
| Productivity | 7,000 | 1,400 | 80.00% |
| Education | 3,500 | 700 | 80.00% |
| Social | 12,000 | 3,600 | 70.00% |

## Выводы

### Технические достижения

1.  ✅ **Реализован полный ETL-процесс** с использованием Apache Airflow.
2.  ✅ **Автоматизирована обработка** разнородных данных (CSV, Excel, JSON).
3.  ✅ **Настроена оркестрация задач** с параллельным выполнением.
4.  ✅ **Реализованы email-уведомления** с отправкой отчетов.

### Бизнес-результаты

1.  📊 **Автоматизирован расчет** ключевых метрик удержания.
2.  🎯 **Выявлены категории приложений** с разными показателями эффективности.
3.  📈 **Сформированы рекомендации** для улучшения продуктовой стратегии.
4.  ⏰ **Сокращено время** на подготовку аналитики.

### Практические навыки

*   Проектирование и реализация ETL-процессов.
*   Работа с Apache Airflow (DAGs, операторы, зависимости).
*   Контейнеризация с Docker Compose.
*   Обработка данных с Python и Pandas.

## Задание и оценка работы

Варианты заданий для выполнения лабораторной работы доступны по ссылке:
**[Скачать варианты заданий](http://95.131.149.21/moodle/mod/assign/view.php?id=1035&forceview=1)**

## 📋 Порядок выполнения работы

### 1. Подготовка окружения

*   Разверните виртуальную машину `dcca_dba_mgpu.ova` в VirtualBox.
*   Клонируйте репозиторий: `git clone https://github.com/BosenkoTM/DCCAS`.

### 2. Изучение Apache Airflow

*   Перейдите в каталог `DCCAS/lw_03` и запустите контейнеры: `sudo docker compose up -d`.
*   Откройте веб-интерфейс Airflow (`http://localhost:8080`).
*   **Задача:** Изучите и опишите в отчете основные элементы интерфейса (страница DAGs, Grid View, Graph View, Logs).

### 3. Проектирование архитектуры

*   **Задача.** Спроектируйте архитектуру для вашего варианта в [draw.io](https://app.diagrams.net/).
*   Архитектура должна включать слои: **Source** (источники), **Storage** (хранение) и **Business** (отчеты, email).

### 📁 Материалы для оценки

1.  **Электронный отчет** (`.pdf` или `.docx`) в LMS или `README.md`.
2.  **Ссылка на публичный репозиторий GitHub**, содержащий:
    *   `README.md` с инструкциями.
    *   Файл DAG (`.py`).
    *   Исходный код проекта (`docker-compose.yml` и др.).
    *   Примеры сгенерированных отчетов.

### 📊 Критерии оценки

*   **Корректность реализации DAG и ETL-логики (40%)**. Правильная последовательность и логика задач, идемпотентность.
*   **Воспроизводимость и использование Docker (20%)**. Проект запускается одной командой.
*   **Функциональность и бизнес-ценность (20%)**. DAG выполняется, результаты корректны, email отправляется.
*   **Качество документации и отчета (20%)**. Понятные инструкции в `README.md` и оформленный отчет.

